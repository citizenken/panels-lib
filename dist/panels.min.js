/*
 panels_package 2016-08-11 
*/
function Parser(a){this.config=a}function Renderer(a,b){this.script=a,this.rootElement=b,this.body=[]}function Script(a){this.config=null,this.elements=[],this.elementGroups={},this.parser=null,this.loadConfig(a)}function ScriptElement(a,b,c){var d;this.text=a,this.type=b,this.id=null,this.subElements=null,this.isSubElement=!1;for(d in c)this[d]=c[d]}var comicbook={elements:{sceneHeading:{strategy:"regex",regex:"(page|PAGE|Page).*(\\([0-9A-Za-z]+ (panels|PANELS)\\))?",element:"h2"},panel:{strategy:"regex",regex:".*?[pP]anel [0-9]+(\\.|:)",element:"strong",subElements:{action:".*"}},character:{strategy:"regex",regex:"(([0-9]+ )?.* ?([0-9]+|\\([A-Z]+\\))?:)",element:"td",subElements:{paren:"( ?\\([A-Z]+\\))?",dialogue:".*"}},dialogue:{strategy:"preceeding",preceeding:"character",element:"p"},action:{strategy:"preceeding",preceeding:"panel",element:"p"}},defaultElement:"action"},panelsConfig={comicbook:comicbook},ScriptElement=window.ScriptElement;Parser.prototype.parseLine=function(a,b){var c,d,e,f,g;e=this.config.elements,c=null;for(f in e)if(d=e[f],"regex"===d.strategy?c=this.parseElementViaRegex(a,f,d):"preceeding"===d.strategy&&(c=this.parseElementViaPreceeding(a,f,d,b)),c){d.subElements&&(g=a.replace(c.text,""),c.subElements=this.parseSubElements(g,d.subElements));break}return c||(c=new ScriptElement(a,this.config.defaultElement)),c},Parser.prototype.parseElementViaRegex=function(a,b,c){var d,e;if(d=new RegExp(c.regex),e=a.match(d),e&&""!==e[0])return new ScriptElement(e[0],b)},Parser.prototype.parseElementViaPreceeding=function(a,b,c,d){var e;if(e=d[d.length-1],e&&e.type===c.preceeding)return new ScriptElement(a,b)},Parser.prototype.parseSubElements=function(a,b){var c,d,e,f,g,h;f=[];for(c in b)h=b[c],d=new RegExp(h),g=a.match(d),g&&""!==g[0]&&(e=new ScriptElement(g[0],c,{isSubElement:!0}),f.push(e),a=a.replace(g[0],""));return f};var $=window.jQuery;Renderer.prototype.generateHTML=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o;if(j=this,c=a,n=this.script.config.elements[a.type].element,d=$("<"+n+">",{id:c.id,"class":c.type,html:c.text}),"td"===n&&(g=$(j.body[j.body.length-1]),"TABLE"!==g.get(0).tagName?m=$("<table>"):(this.body.pop(),m=g),o=$("<tr>").append(d),m.append(o),d=m),a.subElements)for(i=a.subElements,f=0,h=i.length;f<h;f++)k=i[f],l="td"===n?"td":"span",e=$("<"+l+">",{id:k.id,"class":k.type,html:k.text}),"td"===l?o.append(e):d.append(e);return b?d[0].outerHTML:d},Renderer.prototype.renderElements=function(a){var b,c,d;for(d=this,b=d.script.elements,c=0;c<b.length;)b[c].isSubElement||d.body.push(d.generateHTML(b[c],!0)),c++;var e=d.body.join("");return a?a({html:{script:e}}):e},Renderer.prototype.renderElement=function(a){var b,c;return c=this,b=this.generateHTML(a),c.body.push(b),c.rootElement.append(b)},Renderer.prototype.removeElements=function(a){var b,c,d;for(d=this,b=0,c=[];b<a.length;)c.push(d.removeElement(a[b]));return c},Renderer.prototype.removeElement=function(a){return $("#"+a.id).remove()};var config=window.panelsConfig,Parser=window.Parser,_=window.lodash;Script.prototype.loadConfig=function(a){this.config=config[a],this.parser=new Parser(this.config)},Script.prototype.fromBlob=function(a){var b,c,d,e,f,g,h;for(g=a.split("\n"),c=0;c<g.length;){if(f=g[c],""!==f&&(b=this.parser.parseLine(f,this.elements),b&&(this.addElementToList(b),b.subElements)))for(h=b.subElements,d=0,e=h.length;d<e;d++)b=h[d],this.addElementToList(b);c++}return this.elements},Script.prototype.addElementToList=function(a){return a.id=a.type+"_"+this.elements.length,this.elements.push(a),_.isArray(this.elementGroups[a.type])||(this.elementGroups[a.type]=[]),this.elementGroups[a.type].push(a)},ScriptElement.prototype.getElementProperty=function(a){return this[a]};